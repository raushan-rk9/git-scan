<style>
  table img
  {
       width:     auto;
       max-width: 100%;
       height:    auto;
  }

  table.dataTable thead .sorting_asc:before,
  table.dataTable thead .sorting_asc:before,
  table.dataTable thead .sorting_asc:before,
  table.dataTable thead .sorting_asc:before,
  table.dataTable thead .sorting_asc:before,
  table.dataTable thead .sorting_asc:before,
  table.dataTable thead .sorting_asc:before,
  table.dataTable thead .sorting_asc:before,
  table.dataTable thead .sorting_asc:before,
  table.dataTable thead .sorting_asc:before,
  table.dataTable thead .sorting_asc:before,
  table.dataTable thead .sorting_asc:before {}

table th
{
  font-family: verdana !important;
  font-size:   14px    !important;
  line-height: 18px    !important;
}

table td
{
  font-family: verdana !important;
  font-size:   14px    !important;
  line-height: 18px    !important;
}
</style>

<h1><%= "#{t('misc.model_file')} #{t('misc.list')}" %></h1>

<%
    if @item.present?
      action_url   = item_model_files_path(@item)
      new_url      = new_item_model_file_path(@item)
      export_url   = item_model_files_export_path(@item, new_window: true)
      import_url   = item_model_files_import_path(@item)
      renumber_url = item_model_files_renumber_path(@item)
    else
      action_url   = project_model_files_path(@project)
      new_url      = new_project_model_file_path(@project)
      export_url   = project_model_files_export_path(@project, new_window: true)
      import_url   = project_model_files_import_path(@project)
      renumber_url = project_model_files_renumber_path(@project)
    end
 %>
<form name="filter" id="filter" class="filter-form" action="<%= action_url %>"  method="put">
  <div class="filter-form" >
    Field:
    &nbsp;
    <select id="filter_field" name="filter_field" style="width: 25%;">
      <option value="fileid">Model ID</option>
      <option value="full_id">Full ID</option>
      <option value="description">Description</option>
      <option value="file_path">File Path</option>
      <option value="file_type">File Type</option>
      <option value="url_type">URL Type</option>
      <option value="url_link">URL Link</option>
      <option value="url_description">URL Description</option>
      <option value="soft_delete">Marked as Deleted</option>
      <option value="derived">Derived</option>
      <option value="derived_justification">Derived Justification</option>
      <option value="system_requirement_associations"><%= "#{t('misc.system_requirement')} Associations" %></option>
      <option value="high_level_requirement_associations"><%= "#{Item.item_type_title(@item, :high_level, :singular)} Associations" %></option>
      <option value="low_level_requirement_associations"><%= "#{Item.item_type_title(@item, :low_level, :singular)} Associations" %></option>
      <option value="test_case_associations"><%= "#{t('misc.test_case')} Associations" %></option>
      <option value="version">Version</option>
      <option value="revision">Revision</option>
      <option value="draft_version">Draft Revision</option>
      <option value="revision_date">Revision Date</option>
    </select>
    &nbsp;
    Value:
    &nbsp;
    <input id="filter_value" name="filter_value" value='<%= session[:mf_filter_value] %>' type="text" style="width: 25%;">
    &nbsp;
    <input type="submit" value="Filter" style="width: 25%;" class="btn-sm" style="height: 50% !important;" >
  </div>
</form>

<table id="scrollableDataTable" class="table table-striped table-bordered table-sm" cellspacing="0"  width="100%">
  <thead>
    <tr>
      <th class="th-sm"><%= "#{t('misc.model_file')} ID" %></th>
      <th class="th-sm"><%= t('misc.desc') %></th>
      <th class="th-sm"><%= t('misc.filename') %></th>
      <th class="th-sm"><%= t('misc.url') %></th>
      <th class="th-sm">Linked <%= t('misc.system_requirements') %></th>
      <th class="th-sm">Linked <%= Item.item_type_title(@item, :high_level, :plural) %></th>
      <th class="th-sm">Linked <%= Item.item_type_title(@item, :low_level, :plural) %></th>
      <th class="th-sm">Linked <%= t('misc.test_cases') %></th>
      <th class="th-sm"></th>
      <th class="th-sm"></th>
      <th class="th-sm"></th>
      <th class="th-sm"></th>
    </tr>
  </thead>

  <tbody>
    <% @model_files.each do |model_file| %>
      <%
          edit_url            = if @item.present?
                                  edit_item_model_file_path(@item, model_file, new_window: true)
                                else
                                  edit_project_model_file_path(@project, model_file, new_window: true)
                                end
          show_url            = if @item.present?
                                  item_model_file_path(@item, model_file, new_window: true)
                                else
                                  project_model_file_path(@project, model_file, new_window: true)
                                end
          delete_url          = if @item.present?
                                  [@item, model_file]
                                else
                                  [@project, model_file]
                                end
          mark_as_deleted_url = if @item.present?
                                  item_model_file_mark_as_deleted_path(@item,
                                                                       model_file)
                                else
                                  project_model_file_mark_as_deleted_path(@project,
                                                                          model_file)
                                end
          download_url        = if @item.present?
                                  item_model_file_download_path(@item, model_file, new_window: true)
                                else
                                  project_model_file_download_path(@project, model_file, new_window: true)
                                end
       %>

      <% if model_file.soft_delete %>
        <tr>
          <td style='text-decoration: line-through;' ><%= model_file.model_id %></td>
          <td style='text-decoration: line-through;' ><%= raw model_file.description %></td>
          <td style='text-decoration: line-through;' ><%= File.basename(model_file.file_path) if model_file.file_path.present? %></td>
          <td style="text-decoration: line-through; max-width: 200px !important; word-wrap: break-word !important;">
            <% if model_file.url_type.present? && model_file.url_link.present? %>
              <%= link_to model_file.url_link, download_url, target: :_blank %>
            <% else %>
              <%= File.basename(model_file.file_path) if model_file.file_path.present?  %>
            <% end %>
          </td>
          <td style='text-decoration: line-through;' >
            <% if model_file.system_requirements.present? %>
              <% model_file.system_requirements.each do |sysreq| %>
                <%= link_to sysreq.full_id, project_system_requirement_path(@project, sysreq.id, new_window: true), target: :_blank %><br>
              <% end %>
            <% end %>
          </td>
          <td style='text-decoration: line-through;' >
            <% if model_file.high_level_requirements.present? && @item.present? %>
              <% model_file.high_level_requirements.each do |hlr| %>
                <%= link_to hlr.full_id, item_high_level_requirement_path(@item, hlr.id, new_window: true), target: :_blank %><br>
              <% end %>
            <% end %>
          </td>
          <td style='text-decoration: line-through;' >
            <% if model_file.low_level_requirements.present? && @item.present? %>
              <% model_file.low_level_requirements.each do |llr| %>
                <%= link_to llr.full_id, item_low_level_requirement_path(@item, llr.id, new_window: true), target: :_blank %><br>
              <% end %>
            <% end %>
          </td>
          <td style='text-decoration: line-through;' >
            <% if model_file.test_cases.present?  && @item.present? %>
              <% model_file.test_cases.each do |tc| %>
                <%= link_to tc.full_id, item_test_case_path(@item, tc.id, new_window: true), target: :_blank %><br>
              <% end %>
            <% end %>
          </td>
          <td class="td-centered" style='text-decoration: line-through;' >
          </td>
          <td class="td-centered" style='text-decoration: line-through;' >
          </td>
          <td class="td-centered" style='text-decoration: line-through;' >
          </td>
          <td class="td-centered">
            <% if policy(model_file).destroy? %>
              <%= link_to delete_url, method: :delete, data: { confirm: 'Are you sure?' } do %>
                 <%= material_icon.delete.md_24 %><br>Delete
              <% end %>
            <% else %>
              &nbsp;
            <% end %>
          </td>
        </tr>
      <% else %>
        <tr>
					<% if    policy(model_file).edit? && !session[:archives_visible].present? %>
						<td><%= link_to model_file.full_id, edit_url, target: :_blank %></td>
					<% elsif policy(model_file).show? && !session[:archives_visible].present? %>
						<td><%= link_to model_file.full_id, show_url, target: :_blank %></td>
					<% else %>
						<td><%= model_file.full_id %></td>
					<% end %>
          <td><%= raw model_file.description %></td>
          <td><%= File.basename(model_file.file_path) if model_file.file_path.present? %></td>
          <td style="max-width: 200px !important; word-wrap: break-word !important;">
            <% if model_file.url_type.present? && model_file.url_link.present? && @item.present? %>
              <%= link_to model_file.url_link, download_url, target: :_blank %>
            <% else %>
              <%= File.basename(model_file.file_path) if model_file.file_path.present? %>
            <% end %>
          </td>
          <td>
            <% if model_file.system_requirements.present? %>
              <% model_file.system_requirements.each do |sysreq| %>
                <%= link_to sysreq.full_id, project_system_requirement_path(@project, sysreq.id, new_window: true), target: :_blank %><br>
              <% end %>
            <% end %>
          </td>
          <td>
            <% if model_file.high_level_requirements.present? && @item.present? %>
              <% model_file.high_level_requirements.each do |hlr| %>
                <%= link_to hlr.full_id, item_high_level_requirement_path(@item, hlr.id, new_window: true), target: :_blank %><br>
              <% end %>
            <% end %>
          </td>
          <td>
            <% if model_file.low_level_requirements.present? && @item.present?  %>
              <% model_file.low_level_requirements.each do |llr| %>
                <%= link_to llr.full_id, item_low_level_requirement_path(@item, llr.id, new_window: true), target: :_blank %><br>
              <% end %>
            <% end %>
          </td>
          <td>
            <% if model_file.test_cases.present? && @item.present?  %>
              <% model_file.test_cases.each do |tc| %>
                <%= link_to tc.full_id, item_test_case_path(@item, tc.id, new_window: true), target: :_blank %><br>
              <% end %>
            <% end %>
          </td>
          <td class="td-centered">
            <% if policy(model_file).show? %>
              <%= link_to show_url do %>
                <%= material_icon.zoom_in.md_24 %><br>Show
              <% end %>
            <% else %>
              &nbsp;
            <% end %>
          </td>
          <td class="td-centered">
            <% if policy(model_file).edit? && !session[:archives_visible].present? %>
              <%= link_to edit_url do %>
                <%= material_icon.edit.md_24 %><br>Edit
              <% end %>
            <% else %>
              &nbsp;
            <% end %>
          </td>
          <td class="td-centered">
            <% if policy(model_file).destroy? && !session[:archives_visible].present? %>
              <%= link_to mark_as_deleted_url, data: { confirm: 'Are you sure?' } do %>
                <%= material_icon.delete.md_24 %><br>Mark As Deleted
              <% end %>
            <% else %>
              &nbsp;
            <% end %>
          </td>
          <td class="td-centered">
            <% if policy(model_file).destroy? && !session[:archives_visible].present? %>
              <%= link_to delete_url, method: :delete, data: { confirm: 'Are you sure?' } do %>
                 <%= material_icon.delete.md_24 %><br>Delete
              <% end %>
            <% else %>
              &nbsp;
            <% end %>
          </td>
        </tr>
      <% end %>
    <% end %>
  </tbody>
</table>

<br>

<% unless session[:archives_visible].present? %>
  <%= link_to 'New',             new_url,                     class: "btn" %>
<% end %>

<%= link_to 'Export',            export_url, target: :_blank, class: "btn" %>

<% unless session[:archives_visible].present? %>
  <%= link_to 'Import',          import_url,                  class: "btn" %>
  <%= link_to 'Renumber',        renumber_url,                class: "btn", data: { confirm: 'Are you sure?' } %>
<% end %>

<%= link_to 'Back', go_back_path(1),  onclick: 'validateBack(1, this)', class: 'btn' %>

<% if @undo_path.present? && !session[:archives_visible].present? %>
  <%= link_to 'Undo', @undo_path, class: 'btn btn-default', title: @undo_message %>
<% end %>

<% if @redo_path.present? && !session[:archives_visible].present? %>
  <%= link_to 'Redo', @redo_path, class: 'btn btn-default', title: @redo_message %>
<% end %>

<script>
  if (document.cookie.match(/scrollTop=(\d+)/))
    $(window).scrollTop(document.cookie.match(/scrollTop=(\d+)/)[1]);

  $(document).ready
  (
    function()
    {
      var first     = true;
      var sortOrder = '[0, "asc"]';

      if (Cookies.get("table_order"))
        sortOrder = Cookies.get("table_order")
    
      if (document.cookie.match(/scrollTop=(\d+)/))
        $(window).scrollTop(document.cookie.match(/scrollTop=(\d+)/)[1]);

      $('#scrollableDataTable').DataTable
      (
        {
          "sDom":           "Rlfrtip",
          "scrollX":        true,
          "scrollY":        "55vh",
          "aLengthMenu":    [[10, 50, 100, -1], [25, 50, 100, "All"]],
          "pageLength":     -1,
          "scrollCollapse": true,
          "paging":         false,
          "ordering":       true,
          "info":           false,
          "drawCallback":   function(settings)
                            {
                              get_order(!first);
                            },
          "order":          JSON.parse(sortOrder)
        }
      );

     $('[name=filter_field]').val('<%= session[:mf_filter_field] %>');
     $(window).unload(function() {document.cookie = "scrollTop=" + $(window).scrollTop();});

      var tableOrder  = Cookies.get("table_order");

      function get_order(force)
      {
        if (!Cookies.get("table_order") || force)
        {
          var table   = $('#scrollableDataTable').DataTable();
          var date    = new Date();
          var minutes = 30;

          first       = false;

          date.setTime(date.getTime() + (minutes * 60 * 1000));
          Cookies.set('table_order', table.order(), { expires: date });

          return table.order();      
        }
        else
        {
          first       = false;

          return Cookies.get("table_order") ;
        }
      }
    }
  );
</script>