<style>
table.dataTable thead .sorting_asc:before,
table.dataTable thead .sorting_asc:before,
table.dataTable thead .sorting_asc:before,
table.dataTable thead .sorting_asc:before,
table.dataTable thead .sorting_asc:before,
table.dataTable thead .sorting_asc:before,
table.dataTable thead .sorting_asc:before,
table.dataTable thead .sorting_asc:before,
table.dataTable thead .sorting_asc:before,
table.dataTable thead .sorting_asc:before,
table.dataTable thead .sorting_asc:before,
table.dataTable thead .sorting_asc:before,
table.dataTable thead .sorting_asc:before,
table.dataTable thead .sorting_asc:before {}

table img
{
        width:     auto;
        max-width: 100%;
        height:    auto;
}

table th
{
  font-family: verdana !important;
  font-size:   14px    !important;
  line-height: 18px    !important;
}

table td
{
  font-family: verdana !important;
  font-size:   14px    !important;
  line-height: 18px    !important;
}
</style>

<h1>
  <%= "#{Item.item_type_title(@item, :high_level)} #{t('misc.list')}" %>
</h1>

<form name="filter" id="filter" class="filter-form" action="<%= item_high_level_requirements_path(@item) %>"  method="put">
  <div class="filter-form">
    Field:
    &nbsp;
    <select id="filter_field" name="filter_field" style="width: 25%;">
      <option value="full_id"><%= @item.get_item_title(:high_level, :singular_shortened) %></option>
      <option value="description">Description</option>
      <option value="category">Category</option>
      <option value="verification_method">Verification Method</option>
      <option value="safety">Safety</option>
      <option value="robustness">Robustness</option>
      <option value="derived">Derived</option>
      <option value="version">Version</option>
      <option value="system_requirement_associations"><%= t('misc.system_requirements') %></option>
      <option value="derived_justification">Derived Justification</option>
    </select>
    &nbsp;
    Value:
    &nbsp;
    <input id="filter_value" name="filter_value" value='<%= session[:hlr_filter_value] %>' type="text" style="width: 25%;">
    &nbsp;
    <input type="submit" value="Filter" style="width: 25%;" class="btn-sm" style="height: 50% !important;" >
  </div>
</form>

<table id="scrollableDataTable" class="table table-striped table-bordered table-sm" cellspacing="0"  width="100%">
  <thead>
    <tr>
      <th class="th-sm"><%= t('requirements.id') %></th>
      <th class="th-sm"><%= t('misc.desc') %></th>
      <th class="th-sm"><%= t('misc.cat') %></th>
      <th class="th-sm">Safety</th>
      <th class="th-sm">Robustness</th>
      <th class="th-sm">Derived</th>
      <th class="th-sm">Linked System Requirements</th>
      <th class="th-sm">Linked <%= Item.item_type_title(@item, :high_level, :plural) %></th>
      <th class="th-sm">Verification Method</th>
      <th class="th-sm"><%= t('misc.model_file') %></th>
      <th class="th-sm"><%= t('versioning.versionid') %></th>
      <th class="th-sm"></th>
      <th class="th-sm"></th>
      <th class="th-sm"></th>
      <th class="th-sm"></th>
    </tr>
  </thead>

  <tbody>
    <% @high_level_requirements.each do |high_level_requirement| %>
      <% if high_level_requirement.soft_delete %>
        <tr>
          <td style='text-decoration: line-through;' ><%= high_level_requirement.fullreqid %></td>
          <td style='text-decoration: line-through;' ><%= high_level_requirement.description.to_s.html_safe %></td>
          <td style='text-decoration: line-through;' ><%= high_level_requirement.category %></td>
          <td class="td-centered" style='text-decoration: line-through;' ><%= checkicon(high_level_requirement.safety) %></td>
          <td class="td-centered" style='text-decoration: line-through;' ><%= checkicon(high_level_requirement.robustness) %></td>
          <td class="td-centered" style='text-decoration: line-through;' ><%= checkicon(high_level_requirement.derived) %></td>
          <td style='text-decoration: line-through;' >
            <% if high_level_requirement.system_requirements.present? %>
              <% high_level_requirement.system_requirements.each do |sysreq| %>
                <%= link_to sysreq.fullreqid, project_system_requirement_path(@project, sysreq.id) + '?new_window=true', target: :_blank %><br>
              <% end %>
            <% end %>
          </td>
          <td style='text-decoration: line-through;' >
            <% if high_level_requirement.high_level_requirements.present? %>
              <% high_level_requirement.high_level_requirements.each do |hlr| %>
                <%= link_to hlr.full_id, item_high_level_requirement_path(hlr.item_id, hlr.id) + '?new_window=true', target: :_blank %><br>
              <% end %>
            <% end %>
          </td>
          <td style='text-decoration: line-through;' >
            <% if high_level_requirement.verification_method.instance_of?(Array) %>
              <%= high_level_requirement.verification_method.delete_if{ |x| !x.present? }.join("\n") %>
            <% elsif high_level_requirement.verification_method.instance_of?(String) %>
              <%= high_level_requirement.verification_method %>
            <% end %>
          </td>

          <% if high_level_requirement.model_file.try(:description) %>
            <td style='text-decoration: line-through;' >
              <%= high_level_requirement.model_file.try(:description) %>
            </td>
          <% elsif high_level_requirement.document.try(:name) %>
            <td style='text-decoration: line-through;' >
              <%= high_level_requirement.document.try(:name) %>
            </td>
          <% else %>
            <td>
            </td>
          <% end %>

          <td class="td-centered" style='text-decoration: line-through;' ><%= high_level_requirement.version %></td>
          <td class="td-centered" style='text-decoration: line-through;' >
          </td>
          <td class="td-centered" style='text-decoration: line-through;' >
          </td>
          <td class="td-centered" style='text-decoration: line-through;' >
          </td>
          <td class="td-centered">
            <% if policy(high_level_requirement).destroy? %>
              <%= link_to [@item, high_level_requirement], method: :delete, data: { confirm: 'Are you sure?' } do %>
                <%= material_icon.delete.md_24 %><br>Delete
              <% end %>
            <% else %>
              &nbsp;
            <% end %>
          </td>
        </tr>
      <% else %>
        <tr>
                                        <% if    policy(high_level_requirement).edit? && !session[:archives_visible].present? %>
                                                <td><%= link_to high_level_requirement.fullreqid, edit_item_high_level_requirement_path(@item, high_level_requirement)  + '?new_window=true', target: :_blank %></td>
                                        <% elsif policy(high_level_requirement).show? && !session[:archives_visible].present? %>
                                                <td><%= link_to high_level_requirement.fullreqid, item_high_level_requirement_path(@item, high_level_requirement)  + '?new_window=true', target: :_blank %></td>
                                        <% else %>
                                                <td><%= high_level_requirement.fullreqid %></td>
                                        <% end %>
          <td>
            <%= high_level_requirement.description.to_s.html_safe %>

            <% if high_level_requirement.model_file_id.present? && high_level_requirement.model_file.upload_file.attached? %>
              <%= link_to image_tag(high_level_requirement.model_file.upload_file, :size => '25%xauto'), item_model_file_display_path(high_level_requirement.model_file.item_id, high_level_requirement.model_file) + '?new_window=true', target: :_blank %>
            <% elsif high_level_requirement.document_id.present? && high_level_requirement.document.file.attached? %>
              <%= link_to image_tag(high_level_requirement.document.file), item_document_display_path(@item, high_level_requirement.document) + '?new_window=true', target: :_blank %>
            <% end %>
          </td>
          <td><%= high_level_requirement.category %></td>
          <td class="td-centered"><%= checkicon(high_level_requirement.safety) %></td>
          <td class="td-centered"><%= checkicon(high_level_requirement.robustness) %></td>
          <td class="td-centered"><%= checkicon(high_level_requirement.derived) %></td>
          <td>
            <% if high_level_requirement.system_requirements.present? %>
              <% high_level_requirement.system_requirements.each do |sysreq| %>
                <%= link_to sysreq.fullreqid, project_system_requirement_path(@project, sysreq.id) + '?new_window=true', target: :_blank %><br>
              <% end %>
            <% end %>
          </td>
          <td>
            <% if high_level_requirement.high_level_requirement_associations.present? %>
              <% hlrs = high_level_requirement.high_level_requirement_associations.split(',') %>

              <% hlrs.each do |hlr| %>
                <% next unless hlr.present? %>

                <% hlr = HighLevelRequirement.find(hlr) %>
                <%= link_to hlr.full_id, item_high_level_requirement_path(hlr.item_id, hlr.id) + '?new_window=true', target: :_blank %><br>
              <% end %>
            <% end %>
          </td>
          <td>
            <% if high_level_requirement.verification_method.instance_of?(Array) %>
              <%= high_level_requirement.verification_method.delete_if{ |x| !x.present? }.join("\n") %>
            <% elsif high_level_requirement.verification_method.instance_of?(String) %>
              <%= high_level_requirement.verification_method %>
            <% end %>
          </td>

          <% if high_level_requirement.model_file.try(:description) %>
            <td>
              <%= link_to high_level_requirement.model_file.try(:description),
                  item_model_file_path(@item, high_level_requirement.model_file) %>
            </td>
          <% elsif high_level_requirement.document.try(:name) %>
            <td>
              <%= link_to high_level_requirement.document.try(:name),
                  url_for(high_level_requirement.document) + '?new_window=true', target: :_blank %>
            </td>
          <% else %>
            <td>
            </td>
          <% end %>
            
          <td class="td-centered"><%= high_level_requirement.version %></td>
          <td class="td-centered">
           <% if policy(high_level_requirement).show? %>
             <%= link_to item_high_level_requirement_path(@item, high_level_requirement) do %>
               <%= material_icon.zoom_in.md_24 %><br>Show
             <% end %>
           <% else %>
             &nbsp;
           <% end %>
          </td>
          <td class="td-centered">
            <% if policy(high_level_requirement).edit? && !session[:archives_visible].present? %>
              <%= link_to [:edit, @item, high_level_requirement] do %>
               <%= material_icon.edit.md_24 %><br>Edit
            <% end %>
            <% else %>
              &nbsp;
            <% end %>
          </td>
          <td class="td-centered">
            <% if policy(high_level_requirement).destroy? && !session[:archives_visible].present? %>
              <%= link_to item_high_level_requirement_mark_as_deleted_path(@item, high_level_requirement), data: { confirm: 'Are you sure?' } do %>
                <%= material_icon.delete.md_24 %><br>Mark As Deleted
              <% end %>
            <% else %>
              &nbsp;
            <% end %>
          </td>
          <td class="td-centered">
            <% if policy(high_level_requirement).destroy? && !session[:archives_visible].present? %>
              <%= link_to [@item, high_level_requirement], method: :delete, data: { confirm: 'Are you sure?' } do %>
                <%= material_icon.delete.md_24 %><br>Delete
              <% end %>
            <% else %>
              &nbsp;
            <% end %>
          </td>
        </tr>
      <% end %>
        
    <% end %>
  </  tbody>
</table>
<br>

<% unless session[:archives_visible].present? %>
  <%= link_to "New #{Item.item_type_title(@item, :high_level, :singular)}", new_item_high_level_requirement_path(@item), class: "btn" %>
<% end %>

<%= link_to 'Export',   item_high_level_requirements_export_path(@item) + '?new_window=true', target: :_blank,         class: "btn" %>

<% unless session[:archives_visible].present? %>
  <%= link_to 'Import',   item_high_level_requirements_import_path(@item),                                               class: "btn" %>
  <%= link_to 'Renumber', item_high_level_requirements_renumber_path(@item),                                             class: "btn", data: { confirm: 'Are you sure?' } %>
<% end %>

<% unless session[:archives_visible].present? %>
  <%= link_to 'New Baseline',    new_project_requirements_baseline_path(@project, item_id: @item.id, archive_type: Constants::HIGH_LEVEL_REQUIREMENTS_ARCHIVE), class: 'btn' %>
  <%= link_to 'View Baselines',  project_requirements_baselines_path(@project, item_id: @item.id, archive_type: Constants::HIGH_LEVEL_REQUIREMENTS_ARCHIVE), class: 'btn' %>
<% end %>

<%= link_to 'Back', go_back_path(1),  onclick: 'validateBack(1, this)', class: 'btn' %>

<% if @undo_path.present? && !session[:archives_visible].present? %>
  <%= link_to 'Undo', @undo_path, class: 'btn btn-default', title: @undo_message %>
<% end %>

<% if @redo_path.present? && !session[:archives_visible].present? %>
  <%= link_to 'Redo', @redo_path, class: 'btn btn-default', title: @redo_message %>
<% end %>

<script>
  $(document).ready
  (
    function()
    {
      var first     = true;
      var sortOrder = '[0, "asc"]';

      if (Cookies.get("high_level_requirements_table_order"))
        sortOrder = Cookies.get("high_level_requirements_table_order")
    
      if (document.cookie.match(/scrollTop=(\d+)/))
        $(window).scrollTop(document.cookie.match(/scrollTop=(\d+)/)[1]);

      $('#scrollableDataTable').DataTable
      (
        {
          "sDom":           "Rlfrtip",
          "scrollX":        true,
          "scrollY":        "55vh",
          "aLengthMenu":    [[10, 50, 100, -1], [25, 50, 100, "All"]],
          "pageLength":     -1,
          "scrollCollapse": true,
          "paging":         false,
          "ordering":       true,
          "info":           false,
          "drawCallback":   function(settings)
                            {
                              get_order(!first);
                            },
          "order":          JSON.parse(sortOrder)
        }
      );

      $('[name=filter_field]').val('<%= session[:hlr_filter_field] %>');
      $(window).unload(function() {document.cookie = "scrollTop=" + $(window).scrollTop();});

      var tableOrder  = Cookies.get("high_level_requirements_table_order");

      function get_order(force)
      {
        if (!Cookies.get("high_level_requirements_table_order") || force)
        {
          var table   = $('#scrollableDataTable').DataTable();
          var date    = new Date();
          var minutes = 30;

          first       = false;

          date.setTime(date.getTime() + (minutes * 60 * 1000));
          Cookies.set('high_level_requirements_table_order', table.order(), { expires: date });

          return table.order();      
        }
        else
        {
          first       = false;

          return Cookies.get("high_level_requirements_table_order") ;
        }
      }
    }
  );
</script>