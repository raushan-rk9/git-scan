<style>
table.dataTable thead .sorting_asc:before,
table.dataTable thead .sorting_asc:before,
table.dataTable thead .sorting_asc:before,
table.dataTable thead .sorting_asc:before,
table.dataTable thead .sorting_asc:before,
table.dataTable thead .sorting_asc:before,
table.dataTable thead .sorting_asc:before,
table.dataTable thead .sorting_asc:before {}

.inline-label
{ 
}
</style>

<h1>
  Source Code File History
</h1>

<table id="scrollableDataTable" class="table table-striped table-bordered table-sm" cellspacing="0"  width="100%">
  <thead>
    <tr>
      <th class="th-sm"></th>
      <th class="th-sm"><%= t('sourcecodes.codeid') %></th>
      <th class="th-sm"><%= t('misc.desc') %></th>
      <th class="th-sm"><%= t('sourcecodes.filename') %></th>
      <th class="th-sm"><%= t('versioning.external_version') %></th>
      <th class="th-sm"><%= t('versioning.versionid') %></th>
      <th class="th-sm"></th>
      <th class="th-sm"></th>
    </tr>
  </thead>
  <tbody>
    <% @source_codes.each do |source_code| %>
      <tr>
        <td class="td-centered">
          <% if source_code.url_type.present? && source_code.url_link.present? %>
            <input type="checkbox" id='source_code.<%= source_code.id %>' value='<%= source_code.id %>' onclick='selectSourceCode();'}
          <% else %>
            &nbsp;
          <% end %>
        </td>
        <td><%= link_to source_code.fullcodeid, item_source_code_path(@item, source_code)  + '?new_window=true', target: :_blank %></td>
        <td><%= raw source_code.description %></td>
        <td><%= raw(source_code.file_name) %></td>
        <td class="td-centered"><%= source_code.external_version %></td>
        <td class="td-centered"><%= source_code.version %></td>
        <td class="td-centered">
          <% if source_code.url_type == Constants::UPLOAD_ATTACHMENT && source_code.upload_file.attached? %>
            <%= link_to item_source_code_display_path(@item, source_code) do %>
              <%= material_icon.zoom_in.md_24 %><br>Show
            <% end %>
          <% else %>
            &nbsp;
          <% end %>
        </td>
        <td class="td-centered">
          <% if source_code.url_type.present? && source_code.url_link.present? %>
            <% if source_code.url_link =~ /^http.*/i %>
              <%= link_to source_code.url_link, target: :_blank  do %>
                <%= material_icon.get_app.md_24 %><br>Download
              <% end %>
            <% else %>
              <%= link_to item_source_code_download_path(@item, source_code, new_window: true), target: :_blank do %>
                <%= material_icon.get_app.md_24 %><br>Download
              <% end %>
            <% end %>
          <% else %>
            &nbsp;
          <% end %>
        </td>
      </tr>
    <% end %>
  </tbody>
</table>

<br>
<label for="side_by_side"class="inline-label">Side By Side</label>
<input id='side_by_side' name='side_by_side' type='checkbox'>
&nbsp;&nbsp;
<label for="show_c_function"class="inline-label">Show C Function</label>
<input id='show_c_function' name='show_c_function' type='checkbox'>
&nbsp;&nbsp;
<label for="ignore_case"class="inline-label">Ignore Case</label>
<input id='ignore_case' name='ignore_case' type='checkbox'>
&nbsp;&nbsp;
<label for="ignore_whitespace"class="inline-label">Ignore White Space</label>
<input id='ignore_whitespace' name='ignore_whitespace' type='checkbox'>
<br>
<input type='button' id='diff_files' value='Diff Files' onclick='diffFiles();' disabled class='btn' />
<%= link_to 'Back', go_back_path(1),  onclick: 'validateBack(1, this)', class: 'btn' %>

<script>
  function diffFiles()
  {
    var selected                = '';
    var diffOptions             = '-s -t';
    var options                 = '&new_window=true';
    var ignoreCaseChecked       = $('#ignore_case').prop('checked');
    var sideBySideChecked       = $('#side_by_side').prop('checked');
    var showCFunctionChecked    = $('#show_c_function').prop('checked');
    var ignoreWhiteSpaceChecked = $('#ignore_whitespace').prop('checked');

    if (sideBySideChecked)
      diffOptions += ' -y';

    if (showCFunctionChecked)
      diffOptions += ' -p';

    if (ignoreCaseChecked)
      diffOptions += ' -i';

    if (ignoreWhiteSpaceChecked)
      diffOptions += ' -E -b';

    $('[id*="source_code."]').each(function(){
      if ($(this).prop('checked'))
      {
        var value = $(this).prop('value');

        if (selected !== "")
          selected += "," + value;
        else
          selected = value;
      }
    });

    window.open('<%= item_source_codes_diff_path(@item) %>' +
                '?ids=' + selected + options + '&options=' + diffOptions,
                '_blank');
  }

  function selectSourceCode()
  {
    var diffButton = document.getElementById("diff_files");

    if ($('input[type=checkbox]:checked').length == 2)
      diffButton.disabled = false;
    else
      diffButton.disabled = true;
  }

  $( document ).ready(function() {
    if (document.cookie.match(/scrollTop=(\d+)/))
      $(window).scrollTop(document.cookie.match(/scrollTop=(\d+)/)[1]);

    $('#scrollableDataTable').DataTable({
    "sDom":           "Rlfrtip",
    "scrollX":        true,
    "scrollY":        "55vh",
    "aLengthMenu":    [[10, 50, 100, -1], [25, 50, 100, "All"]],
    "pageLength":     -1,
    "scrollCollapse": true,
    "paging":         false,
    "ordering":       true,
    "info":           false,
    });
  });

  $(window).unload(function() {document.cookie = "scrollTop=" + $(window).scrollTop();});
</script>