<style>
table.dataTable thead .sorting_asc:before,
table.dataTable thead .sorting_asc:before,
table.dataTable thead .sorting_asc:before,
table.dataTable thead .sorting_asc:before,
table.dataTable thead .sorting_asc:before,
table.dataTable thead .sorting_asc:before,
table.dataTable thead .sorting_asc:before,
table.dataTable thead .sorting_asc:before,
table.dataTable thead .sorting_asc:before,
table.dataTable thead .sorting_asc:before,
table.dataTable thead .sorting_asc:before,
table.dataTable thead .sorting_asc:before {}

table img
{
	width:     auto;
	max-width: 100%;
	height:    auto;
}

table th
{
  font-family: verdana !important;
  font-size:   14px    !important;
  line-height: 18px    !important;
}

table td
{
  font-family: verdana !important;
  font-size:   14px    !important;
  line-height: 18px    !important;
}
</style>
<h1><%= "#{t('problemreports.pl_title')} #{t('misc.list')}" %></h1>

<form name="filter" id="filter" class="filter-form" action="<%= project_problem_reports_path(@project) %>"  method="put">
  <div class="filter-form">
    Field:
    &nbsp;
    <select id="filter_field" name="filter_field" style="width: 25%;">
      <option value="prid">Problem Report ID</option>
      <option value="dateopened">Date Opened</option>
      <option value="status">Status</option>
      <option value="openedby">Opened By</option>
      <option value="title">Title</option>
      <option value="product">Product</option>
      <option value="criticality">Criticality</option>
      <option value="source">Source</option>
      <option value="discipline_assigned">Discipline Assigned</option>
      <option value="assignedto">Assigned To</option>
      <option value="target_date">Target Date</option>
      <option value="close_date">Close Date</option>
      <option value="description">Description</option>
      <option value="problemfoundin">Problem Found In</option>
      <option value="correctiveaction">Corrective Action</option>
      <option value="fixed_in">Fixed In</option>
      <option value="verification">Verification</option>
      <option value="feedback">Feedback</option>
      <option value="notes">Notes</option>
      <option value="meeting_id">Meeting ID</option>
      <option value="safetyrelated">Safety Related</option>
      <option value="datemodified">Date Modified</option>
    </select>
    &nbsp;
    Value:
    &nbsp;
    <input id="filter_value" name="filter_value" value='<%= session[:pr_filter_value] %>' type="text" style="width: 25%;">
    &nbsp;
    <input type="submit" value="Filter" style="width: 25%;" class="btn-sm" style="height: 50% !important;" >
  </div>
</form>

<table id="scrollableDataTable" class="table table-striped table-bordered table-sm" cellspacing="0"  width="100%">
  <thead>
    <tr>
      <th class="th-sm"><%= t('problemreports.id') %></th>
      <th class="th-sm"><%= t('misc.title') %></th>
      <th class="th-sm"><%= t('misc.desc') %></th>
      <th class="th-sm"><%= t('items.single_title') %></th>
      <th class="th-sm"><%= t('problemreports.openedby') %></th>
      <th class="th-sm"><%= t('problemreports.assignedto') %></th>
      <th class="th-sm"><%= t('misc.status') %></th>
      <th class="th-sm"><%= t('problemreports.safety') %></th>
      <th class="th-sm"><%= t('problemreports.crit') %></th>
      <th class="th-sm"><%= t('problemreports.datemod') %></th>
      <th class="th-sm"><%= t('problemreports.history') %></th>
      <th class="th-sm"></th>
      <th class="th-sm"></th>
    </tr>
  </thead>

  <tbody>
    <% @problem_reports.each do |problem_report| %>
      <tr>
        <td><%= problem_report.prid %></td>
        <td><%= problem_report.title %></td>
        <td style="max-width: 600px !important; word-wrap: break-word !important; overflow: auto !important;"><%= sanitize problem_report.description %></td>
				<td>
          <%= @project.name %>
					:
					<%= Item.identifier_from_id(problem_report.item_id) %>
				</td>
        <td><%= User.fullname_from_email(problem_report.openedby) %></td>
        <td><%= User.fullname_from_email(problem_report.assignedto) %></td>
        <td><%= problem_report.status %></td>
        <td class="td-centered"><%= checkicon(problem_report.safetyrelated) %></td>
        <td><%= problem_report.criticality %></td>
        <td><%= problem_report.datemodified %></td>
        <td><%= link_to t('problemreports.history'), problem_report_problem_report_histories_path(problem_report) %></td>
        <td>
          <% if policy(problem_report).show? %>
            <%= link_to project_problem_report_path(@project, problem_report) do %>
              <%= material_icon.zoom_in.md_24 %><br>Show
            <% end %>
          <% else %>
            &nbsp;
          <% end %>
        </td>
        <td class="td-centered">
          <% if policy(problem_report).edit? %>
            <%= link_to [:edit, @project, problem_report] do %>
              <%= material_icon.edit.md_24 %><br>Edit
            <% end %>
          <% else %>
            &nbsp;
          <% end %>
        </td>
      </tr>
    <% end %>
  </tbody>
</table>

<br>

<%= link_to 'New Problem Report',
            new_project_problem_report_path(@project) + '?new_window=true',
						target: :_blank,
            class: "btn btn-primary" %>
<%= link_to 'Export',
             project_problem_reports_export_path(@project) + '?new_window=true',
             target: :_blank,
             class: "btn btn-primary" %>
<%= link_to 'Import',
             project_problem_reports_import_path(@project),
             class: "btn btn-primary" %>
<%= link_to 'All Problem Reports',
             project_problem_reports_path(@project, clear_filter: true),
             class: 'btn btn-default' %>
<%= link_to 'PRs Opened by me',
            project_problem_reports_path(@project, my_problem_reports: true),
            class: 'btn btn-default' %>
<%= link_to 'PRs Assigned to Me',
            project_problem_reports_path(@project,
                                         problem_reports_assigned_to_me: true),
            class: 'btn btn-default' %>

<%= link_to 'Back', go_back_path(1),  onclick: 'validateBack(1, this)', class: 'btn' %>

<% if @undo_path.present? && !session[:archives_visible].present? %>
  <%= link_to 'Undo', @undo_path, class: 'btn btn-default', title: @undo_message %>
<% end %>

<% if @redo_path.present? && !session[:archives_visible].present? %>
  <%= link_to 'Redo', @redo_path, class: 'btn btn-default', title: @redo_message %>
<% end %>

<script>
  $(document).ready
  (
    function()
    {
      var first     = true;
      var sortOrder = '[0, "asc"]';

      if (Cookies.get("problem_reports_table_order"))
        sortOrder = Cookies.get("problem_reports_table_order")
    
      if (document.cookie.match(/scrollTop=(\d+)/))
        $(window).scrollTop(document.cookie.match(/scrollTop=(\d+)/)[1]);

      $('#scrollableDataTable').DataTable
      (
        {
          "sDom":           "Rlfrtip",
					"scrollX":        true,
          "scrollY":        "55vh",
          "aLengthMenu":    [[10, 50, 100, -1], [25, 50, 100, "All"]],
          "pageLength":     -1,
          "scrollCollapse": true,
          "paging":         false,
          "ordering":       true,
          "info":           false,
          "drawCallback":   function(settings)
                            {
                              get_order(!first);
                            },
          "order":          JSON.parse(sortOrder)
        }
      );

      $('[name=filter_field]').val('<%= session[:hlr_filter_field] %>');
      $(window).unload(function() {document.cookie = "scrollTop=" + $(window).scrollTop();});

      var tableOrder  = Cookies.get("problem_reports_table_order");

      function get_order(force)
      {
        if (!Cookies.get("problem_reports_table_order") || force)
        {
          var table   = $('#scrollableDataTable').DataTable();
          var date    = new Date();
          var minutes = 30;

          first       = false;

          date.setTime(date.getTime() + (minutes * 60 * 1000));
          Cookies.set('problem_reports_table_order', table.order(), { expires: date });

          return table.order();      
        }
        else
        {
          first       = false;

          return Cookies.get("problem_reports_table_order") ;
        }
      }
    }
  );
</script>
