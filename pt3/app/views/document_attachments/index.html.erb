<style>
table.dataTable thead .sorting_asc:before,
table.dataTable thead .sorting_asc:before,
table.dataTable thead .sorting_asc:before,
table.dataTable thead .sorting_asc:before,
table.dataTable thead .sorting_asc:before,
table.dataTable thead .sorting_asc:before,
table.dataTable thead .sorting_asc:before {}

table th
{
  font-family: verdana !important;
  font-size:   14px    !important;
  line-height: 18px    !important;
}

table td
{
  font-family: verdana !important;
  font-size:   14px    !important;
  line-height: 18px    !important;
}
</style>

<h1>Document Attachments <%= t('misc.list') %></h1>

<table id="scrollableDataTable" class="table table-striped table-bordered table-sm" cellspacing="0"  width="100%">
  <thead>
    <tr>
      <th class="th-sm">Name</th>
      <th class="th-sm">Document</th>
      <th class="th-sm">User</th>
      <th class="th-sm">Uploaded at</th>
      <th class="th-sm"></th>
      <th class="th-sm"></th>
      <th class="th-sm"></th>
    </tr>
  </thead>

  <tbody>
    <% @document_attachments.each do |document_attachment| %>
      <tr>
        <td>
          <% if document_attachment.file.attached? %>
            <% if document_attachment.file.filename.to_s =~ /^.*\.pdf$/i %>
              <%= material_icon.picture_as_pdf.md_24 %>
            <% elsif document_attachment.file.filename.to_s =~ /^.*\.(txt|doc|docx|odt)$/i %>
              <%= material_icon.description.md_24 %>
            <% elsif document_attachment.file.filename.to_s =~ /^.*\.(xls|xlsx|csv|ods)$/i %>
              <%= material_icon.apps.md_24 %>
            <% elsif document_attachment.file.filename.to_s =~ /^.*\.(jpg|jpeg|png|tiff|bmp|ico|svg)$/i %>
              <%= material_icon.insert_photo.md_24 %>
            <% elsif document_attachment.file.filename.to_s =~ /^.*\.(jpg|jpeg|png|tiff|bmp|ico|svg)$/i %>
              <%= material_icon.insert_photo.md_24 %>
            <% elsif document_attachment.file.filename.to_s =~ /^.*\.(vdx|vsd|vsdx)$/i %>
              <%= material_icon.usb.md_24.r180 %>
            <% elsif document_attachment.file.filename.to_s =~ /^.*\.(ppt|pptx)$/i %>
              <%= material_icon.slideshow.md_24 %>
            <% elsif document_attachment.file.filename.to_s =~ /^.*\.(mov|wmv|flv|avi|mp4)$/i %>
              <%= material_icon.movie.md_24 %>
            <% elsif document_attachment.file.filename.to_s =~ /^.*\.(mp3|wav|aiff|wma)$/i %>
              <%= material_icon.music_note.md_24 %>
            <% elsif document_attachment.file.filename.to_s =~ /^.*\.gif$/i %>
              <%= material_icon.gif.md_24 %>
            <% elsif document_attachment.file.filename.to_s =~ /^.*\.(zip||gz|7z|tar)$/i %>
              <%= material_icon.archive.md_24 %>
            <% elsif document_attachment.file.filename.to_s =~ /^.*\.html$/i %>
              <%= material_icon.http.md_24 %>
            <% elsif document_attachment.file.filename.to_s =~ /^.*\.([ch]|cpp|c++|bat|sh|pl|java|rb|js|php|yml|erb)$/i %>
              <%= material_icon.code.md_24 %>
            <% else %>
              <%= material_icon.help.md_24 %>
            <% end %>
            &nbsp;
            <%= link_to document_attachment.file.filename, url_for(document_attachment.file) %>
          <% end %>
        </td>
        <td><%= document_attachment.document.name %></td>
        <td><%= document_attachment.user %></td>
        <td><%= document_attachment.upload_date %></td>
        <td class="td-centered">
          <% if policy(document_attachment).show? %>
            <%= link_to document_document_attachment_path(@document, document_attachment) do %>
              <%= material_icon.zoom_in.md_24 %><br>Show
            <% end %>
          <% else %>
            &nbsp;
          <% end %>
        </td>
        <td class="td-centered">
          <% if policy(document_attachment).edit? %>
            <%= link_to edit_document_document_attachment_path(@document, document_attachment) do %>
              <%= material_icon.edit.md_24 %><br>Edit
            <% end %>
          <% else %>
            &nbsp;
          <% end %>
        </td>
        <td class="td-centered">
          <% if policy(document_attachment).destroy? %>
            <%= link_to document_document_attachment_path(@document, document_attachment), method: :delete, data: { confirm: 'Are you sure?' } do %>
              <%= material_icon.delete.md_24 %><br>Delete
            <% end %>
          <% else %>
            &nbsp;
          <% end %>
        </td>
      </tr>
    <% end %>
  </tbody>
</table>

<br>

<%= link_to 'New Document Attachment', new_document_document_attachment_path(@document), class: 'btn btn-default' %>
<%= link_to 'Back',                    go_back_path(1),  onclick: 'validateBack(1, this)',                                  class: 'btn' %>

<% if @undo_path.present? && !session[:archives_visible].present? %>
  <%= link_to 'Undo', @undo_path, class: 'btn btn-default', title: @undo_message %>
<% end %>

<% if @redo_path.present? && !session[:archives_visible].present? %>
  <%= link_to 'Redo', @redo_path, class: 'btn btn-default', title: @redo_message %>
<% end %>

<script>
  if (document.cookie.match(/scrollTop=(\d+)/))
    $(window).scrollTop(document.cookie.match(/scrollTop=(\d+)/)[1]);

  $(document).ready
  (
    function()
    {
      var first     = true;
      var sortOrder = '[0, "asc"]';

      if (Cookies.get("document_attachments_table_order"))
        sortOrder = Cookies.get("document_attachments_table_order")
    
      if (document.cookie.match(/scrollTop=(\d+)/))
        $(window).scrollTop(document.cookie.match(/scrollTop=(\d+)/)[1]);

      $('#scrollableDataTable').DataTable
      (
        {
          "sDom":           "Rlfrtip",
          "scrollX":        true,
          "scrollY":        "55vh",
          "aLengthMenu":    [[10, 50, 100, -1], [25, 50, 100, "All"]],
          "pageLength":     -1,
          "scrollCollapse": true,
          "paging":         false,
          "ordering":       true,
          "info":           false,
          "drawCallback":   function(settings)
                            {
                              get_order(!first);
                            },
          "order":          JSON.parse(sortOrder)
        }
      );

      $(window).unload(function() {document.cookie = "scrollTop=" + $(window).scrollTop();});

      var tableOrder  = Cookies.get("document_attachments_table_order");

      function get_order(force)
      {
        if (!Cookies.get("document_attachments_table_order") || force)
        {
          var table   = $('#scrollableDataTable').DataTable();
          var date    = new Date();
          var minutes = 30;

          first       = false;

          date.setTime(date.getTime() + (minutes * 60 * 1000));
          Cookies.set('document_attachments_table_order', table.order(), { expires: date });

          return table.order();      
        }
        else
        {
          first       = false;

          return Cookies.get("document_attachments_table_order") ;
        }
      }
    }
  );
</script>